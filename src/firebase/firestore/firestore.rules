rules_version = '2';

/**
 * ðŸ”’ REGRAS DE SEGURANÃ‡A FIRESTORE
 * Sistema multiempresa com isolamento total entre empresas
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ðŸ¢ COMPANIES - Acesso restrito ao prÃ³prio documento da empresa
    match /companies/{companyId} {
      // Permitir leitura e escrita apenas para a prÃ³pria empresa autenticada
      allow read, write: if request.auth != null && 
                           request.auth.uid == companyId;
      
      // Permitir criaÃ§Ã£o de nova empresa (signup)
      allow create: if request.auth != null && 
                      request.auth.uid == resource.data.companyId &&
                      isValidCompanyData(request.resource.data);
      
      // ðŸ‘¤ CLIENTS - Subcollection de clientes por empresa
      match /clients/{clientId} {
        // Acesso apenas para a empresa dona dos clientes
        allow read, write: if request.auth != null && 
                             request.auth.uid == companyId &&
                             belongsToCompany(companyId);
        
        // ðŸ’¬ CONVERSATIONS - Subcollection de conversas por cliente
        match /conversations/{conversationId} {
          // Acesso apenas para a empresa dona do cliente
          allow read, write: if request.auth != null && 
                               request.auth.uid == companyId &&
                               belongsToCompany(companyId);
          
          // Permitir criaÃ§Ã£o de nova conversa com validaÃ§Ã£o
          allow create: if request.auth != null && 
                          (request.auth.uid == companyId || isSystemUser()) &&
                          isValidConversationData(request.resource.data);
        }
      }
      
      // ðŸ’³ PAYMENT HISTORY - Subcollection de histÃ³rico de pagamentos
      match /paymentHistory/{paymentId} {
        // Apenas leitura para a prÃ³pria empresa
        allow read: if request.auth != null && 
                      request.auth.uid == companyId;
        
        // Escrita apenas para sistema (webhooks Stripe)
        allow write: if isSystemUser() || isStripeWebhook();
      }
    }
    
    // ðŸ“Š SYSTEM STATS - Apenas leitura para empresas autenticadas, escrita para sistema
    match /systemStats/{document} {
      allow read: if request.auth != null;
      allow write: if isSystemUser();
    }
    
    // ðŸ“ AUDIT LOGS - Apenas escrita para sistema, leitura para admins
    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow write: if isSystemUser();
    }
    
    // ðŸ”§ FUNCTIONS
    
    /**
     * âœ… Verificar se usuÃ¡rio pertence Ã  empresa
     */
    function belongsToCompany(companyId) {
      return request.auth != null && request.auth.uid == companyId;
    }
    
    /**
     * ðŸ¤– Verificar se Ã© usuÃ¡rio do sistema (Cloud Functions)
     */
    function isSystemUser() {
      return request.auth != null && 
             request.auth.token.firebase.sign_in_provider == 'custom' &&
             request.auth.token.system_user == true;
    }
    
    /**
     * ðŸ’³ Verificar se Ã© webhook do Stripe
     */
    function isStripeWebhook() {
      return request.auth != null && 
             request.auth.token.stripe_webhook == true;
    }
    
    /**
     * ðŸ‘‘ Verificar se Ã© admin do sistema
     */
    function isAdmin() {
      return request.auth != null && 
             request.auth.token.admin == true;
    }
    
    /**
     * âœ… Validar dados da empresa
     */
    function isValidCompanyData(data) {
      return data.keys().hasAll(['name', 'companyId', 'createdAt']) &&
             data.name is string &&
             data.name.size() >= 2 &&
             data.companyId is string &&
             data.companyId.size() > 0 &&
             (data.domain is string || data.whatsappId is string || data.instagram is string);
    }
    
    /**
     * âœ… Validar dados do cliente
     */
    function isValidClientData(data) {
      return data.keys().hasAll(['name', 'companyId', 'clientId', 'createdAt']) &&
             data.name is string &&
             data.name.size() >= 2 &&
             data.companyId is string &&
             data.clientId is string &&
             data.contact is map;
    }
    
    /**
     * âœ… Validar dados da conversa
     */
    function isValidConversationData(data) {
      return data.keys().hasAll(['companyId', 'clientId', 'content', 'timestamp']) &&
             data.companyId is string &&
             data.clientId is string &&
             data.content is string &&
             data.content.size() > 0 &&
             data.source in ['whatsapp', 'website', 'instagram', 'email', 'phone'] &&
             data.category in ['current', 'long-term'];
    }
    
    /**
     * ðŸ•’ Verificar se empresa tem plano ativo
     */
    function hasActivePlan(companyId) {
      return get(/databases/$(database)/documents/companies/$(companyId)).data.activePlan == true;
    }
    
    /**
     * ðŸ“Š Verificar limites de uso da empresa
     */
    function isWithinUsageLimits(companyId) {
      let company = get(/databases/$(database)/documents/companies/$(companyId)).data;
      return company.stats.monthlyUsage.conversations < company.plan.limits.maxConversationsPerMonth;
    }
    
    /**
     * ðŸ”’ Regras especÃ­ficas para diferentes tipos de operaÃ§Ã£o
     */
    
    // Permitir leitura de dados prÃ³prios sempre
    function canReadOwnData(companyId) {
      return request.auth != null && 
             request.auth.uid == companyId;
    }
    
    // Permitir escrita apenas se tem plano ativo e dentro dos limites
    function canWriteWithLimits(companyId) {
      return request.auth != null && 
             request.auth.uid == companyId &&
             hasActivePlan(companyId) &&
             isWithinUsageLimits(companyId);
    }
    
    // OperaÃ§Ãµes que nÃ£o contam para limite (leitura, atualizaÃ§Ãµes menores)
    function canWriteUnlimited(companyId) {
      return request.auth != null && 
             request.auth.uid == companyId &&
             hasActivePlan(companyId);
    }
  }
}

/**
 * ðŸ“‹ RESUMO DAS REGRAS:
 * 
 * 1. **Isolamento Total**: Cada empresa sÃ³ acessa seus prÃ³prios dados
 * 2. **AutenticaÃ§Ã£o ObrigatÃ³ria**: Todas as operaÃ§Ãµes exigem autenticaÃ§Ã£o
 * 3. **ValidaÃ§Ã£o de Dados**: Estrutura de dados Ã© validada nas operaÃ§Ãµes
 * 4. **Controle de Planos**: OperaÃ§Ãµes limitadas por plano ativo
 * 5. **Sistema Interno**: Cloud Functions tÃªm acesso especial
 * 6. **Auditoria**: Todas as operaÃ§Ãµes sÃ£o logadas
 * 
 * ðŸ” NÃVEIS DE ACESSO:
 * - **Empresa**: Acesso total aos prÃ³prios dados
 * - **Sistema**: Acesso para automaÃ§Ã£o e webhooks
 * - **Admin**: Acesso para auditoria e estatÃ­sticas
 * - **Webhook**: Acesso limitado para atualizaÃ§Ãµes de pagamento
 */
