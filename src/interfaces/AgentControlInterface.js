/**
 * üéõÔ∏è AGENT CONTROL INTERFACE
 * 
 * Interface para monitorar e controlar o agente IA
 * Dashboard em linha de comando para facilitar gest√£o
 */

const AgentePrincipal = require('../agents/AgentePrincipal');
const readline = require('readline');
const { Timestamp } = require('firebase-admin/firestore');

class AgentControlInterface {
    constructor() {
        this.agent = new AgentePrincipal();
        this.isRunning = false;
        this.rl = readline.createInterface({
            input: process.stdin,
            output: process.stdout
        });

        console.log('üéõÔ∏è Agent Control Interface inicializada');
    }

    /**
     * üöÄ INICIAR INTERFACE
     */
    async start() {
        console.log('\n' + '='.repeat(60));
        console.log('ü§ñ AGENTE IA PRINCIPAL - INTERFACE DE CONTROLE');
        console.log('='.repeat(60));

        await this.showStatus();
        this.showMenu();
        this.isRunning = true;
        this.handleUserInput();
    }

    /**
     * üìä MOSTRAR STATUS DO AGENTE
     */
    async showStatus() {
        try {
            console.log('\nüìä STATUS DO AGENTE:');
            console.log('-'.repeat(30));

            // Health check
            const health = await this.agent.healthCheck();
            console.log(`Status: ${this.getStatusEmoji(health.status)} ${health.status.toUpperCase()}`);

            // Configura√ß√µes atuais
            console.log('\n‚öôÔ∏è CONFIGURA√á√ïES:');
            console.log(`Auto Response: ${this.agent.config.autoResponse ? '‚úÖ' : '‚ùå'}`);
            console.log(`Learning: ${this.agent.config.learningEnabled ? '‚úÖ' : '‚ùå'}`);
            console.log(`Confidence Threshold: ${this.agent.config.confidenceThreshold}`);
            console.log(`Fallback to Human: ${this.agent.config.fallbackToHuman ? '‚úÖ' : '‚ùå'}`);

            // Servi√ßos
            console.log('\nüîß SERVI√áOS:');
            Object.entries(health.services).forEach(([service, status]) => {
                console.log(`${service}: ${status === 'ok' ? '‚úÖ' : '‚ùå'} ${status}`);
            });

            // Estat√≠sticas recentes
            const stats = await this.agent.getStats(null, '24h');
            if (stats.success) {
                console.log('\nüìà √öLTIMAS 24H:');
                console.log(`Intera√ß√µes: ${stats.stats.totalInteractions}`);
                console.log(`Taxa de Resposta: ${(stats.stats.responseRate * 100).toFixed(1)}%`);
                console.log(`Confian√ßa M√©dia: ${(stats.stats.averageConfidence * 100).toFixed(1)}%`);
            }

        } catch (error) {
            console.log(`‚ùå Erro ao obter status: ${error.message}`);
        }
    }

    /**
     * üìã MOSTRAR MENU
     */
    showMenu() {
        console.log('\n' + '='.repeat(60));
        console.log('üìã COMANDOS DISPON√çVEIS:');
        console.log('='.repeat(60));
        console.log('1. status          - Mostrar status atual');
        console.log('2. config          - Modificar configura√ß√µes');
        console.log('3. test <message>  - Testar mensagem');
        console.log('4. stats [company] - Ver estat√≠sticas');
        console.log('5. companies       - Listar empresas');
        console.log('6. monitor         - Modo monitor (tempo real)');
        console.log('7. optimize        - Otimizar performance');
        console.log('8. help            - Mostrar ajuda');
        console.log('9. quit            - Sair');
        console.log('='.repeat(60));
        console.log('Digite um comando:');
    }

    /**
     * üéØ PROCESSAR ENTRADA DO USU√ÅRIO
     */
    handleUserInput() {
        this.rl.on('line', async (input) => {
            const [command, ...args] = input.trim().split(' ');

            try {
                switch (command.toLowerCase()) {
                    case '1':
                    case 'status':
                        await this.showStatus();
                        break;

                    case '2':
                    case 'config':
                        await this.handleConfigCommand();
                        break;

                    case '3':
                    case 'test':
                        await this.handleTestCommand(args.join(' '));
                        break;

                    case '4':
                    case 'stats':
                        await this.handleStatsCommand(args[0]);
                        break;

                    case '5':
                    case 'companies':
                        await this.handleCompaniesCommand();
                        break;

                    case '6':
                    case 'monitor':
                        await this.handleMonitorCommand();
                        break;

                    case '7':
                    case 'optimize':
                        await this.handleOptimizeCommand();
                        break;

                    case '8':
                    case 'help':
                        this.showHelp();
                        break;

                    case '9':
                    case 'quit':
                    case 'exit':
                        await this.quit();
                        return;

                    default:
                        console.log(`‚ùå Comando n√£o reconhecido: ${command}`);
                        console.log('Digite "help" para ver comandos dispon√≠veis.');
                }

            } catch (error) {
                console.log(`‚ùå Erro ao executar comando: ${error.message}`);
            }

            console.log('\n> ');
        });
    }

    /**
     * ‚öôÔ∏è CONFIGURAR AGENTE
     */
    async handleConfigCommand() {
        console.log('\n‚öôÔ∏è CONFIGURA√á√ÉO DO AGENTE:');
        console.log('='.repeat(40));

        const questions = [
            {
                key: 'autoResponse',
                prompt: 'Auto Response (true/false): ',
                current: this.agent.config.autoResponse
            },
            {
                key: 'learningEnabled',
                prompt: 'Learning Enabled (true/false): ',
                current: this.agent.config.learningEnabled
            },
            {
                key: 'confidenceThreshold',
                prompt: 'Confidence Threshold (0.0-1.0): ',
                current: this.agent.config.confidenceThreshold
            },
            {
                key: 'fallbackToHuman',
                prompt: 'Fallback to Human (true/false): ',
                current: this.agent.config.fallbackToHuman
            }
        ];

        const newConfig = {};

        for (const question of questions) {
            const answer = await this.askQuestion(
                `${question.prompt}[atual: ${question.current}] `
            );

            if (answer.trim()) {
                if (question.key === 'confidenceThreshold') {
                    newConfig[question.key] = parseFloat(answer);
                } else {
                    newConfig[question.key] = answer.toLowerCase() === 'true';
                }
            }
        }

        if (Object.keys(newConfig).length > 0) {
            this.agent.configure(newConfig);
            console.log('‚úÖ Configura√ß√£o atualizada!');
        } else {
            console.log('‚ö†Ô∏è Nenhuma configura√ß√£o alterada.');
        }
    }

    /**
     * üß™ TESTAR MENSAGEM
     */
    async handleTestCommand(message) {
        if (!message.trim()) {
            console.log('‚ùå Forne√ßa uma mensagem para testar.');
            console.log('Exemplo: test Ol√°, gostaria de fazer um pedido');
            return;
        }

        console.log('\nüß™ TESTANDO MENSAGEM:');
        console.log(`Mensagem: "${message}"`);
        console.log('-'.repeat(50));

        try {
            // Simular dados de teste
            const companyId = 'test-company';
            const clientId = 'test-client';

            const result = await this.agent.testMode(message, companyId, clientId);

            if (result.success) {
                console.log('‚úÖ RESULTADO DO TESTE:');
                console.log(`Categoria: ${result.analysis.category}`);
                console.log(`Confian√ßa: ${(result.analysis.confidence * 100).toFixed(1)}%`);
                console.log(`Sentimento: ${result.analysis.sentiment}`);
                console.log(`Urg√™ncia: ${result.analysis.urgency}`);
                
                if (result.response) {
                    console.log(`\nüí¨ RESPOSTA GERADA:`);
                    console.log(`"${result.response.content}"`);
                    console.log(`Confian√ßa da resposta: ${(result.response.confidence * 100).toFixed(1)}%`);
                } else {
                    console.log('\n‚ö†Ô∏è Nenhuma resposta autom√°tica gerada');
                }

                console.log(`\n‚è±Ô∏è Tempo de processamento: ${result.processingTime}ms`);

            } else {
                console.log(`‚ùå Teste falhou: ${result.error}`);
            }

        } catch (error) {
            console.log(`‚ùå Erro no teste: ${error.message}`);
        }
    }

    /**
     * üìä MOSTRAR ESTAT√çSTICAS
     */
    async handleStatsCommand(companyId) {
        console.log('\nüìä ESTAT√çSTICAS:');
        console.log('='.repeat(50));

        try {
            const timeRanges = ['24h', '7d', '30d'];

            for (const range of timeRanges) {
                const stats = await this.agent.getStats(companyId, range.replace('d', '') * 24 + 'h');
                
                if (stats.success) {
                    console.log(`\n‚è∞ √öLTIMOS ${range.replace('h', ' horas').replace('d', ' dias')}:`);
                    console.log(`Intera√ß√µes: ${stats.stats.totalInteractions}`);
                    console.log(`Taxa de Resposta: ${(stats.stats.responseRate * 100).toFixed(1)}%`);
                    console.log(`Confian√ßa M√©dia: ${(stats.stats.averageConfidence * 100).toFixed(1)}%`);
                }
            }

        } catch (error) {
            console.log(`‚ùå Erro ao obter estat√≠sticas: ${error.message}`);
        }
    }

    /**
     * üè¢ LISTAR EMPRESAS
     */
    async handleCompaniesCommand() {
        console.log('\nüè¢ EMPRESAS CADASTRADAS:');
        console.log('='.repeat(50));

        try {
            const CompaniesService = require('../firebase/firestore/companies');
            const companiesService = new CompaniesService();
            
            const companies = await companiesService.listCompanies();

            if (companies.length === 0) {
                console.log('‚ö†Ô∏è Nenhuma empresa cadastrada.');
                return;
            }

            companies.forEach((company, index) => {
                console.log(`\n${index + 1}. ${company.name}`);
                console.log(`   ID: ${company.companyId || company.id}`);
                console.log(`   Dom√≠nio: ${company.domain || 'N/A'}`);
                console.log(`   WhatsApp: ${company.whatsappId || company.whatsapp || 'N/A'}`);
                console.log(`   Plano: ${company.activePlan ? '‚úÖ Ativo' : '‚ùå Inativo'}`);
            });

        } catch (error) {
            console.log(`‚ùå Erro ao listar empresas: ${error.message}`);
        }
    }

    /**
     * üëÅÔ∏è MODO MONITOR
     */
    async handleMonitorCommand() {
        console.log('\nüëÅÔ∏è MODO MONITOR ATIVADO');
        console.log('Pressione CTRL+C para sair do monitor');
        console.log('='.repeat(50));

        const interval = setInterval(async () => {
            try {
                const stats = await this.agent.getStats(null, '1h');
                if (stats.success) {
                    console.log(`[${new Date().toLocaleTimeString()}] Intera√ß√µes: ${stats.stats.totalInteractions} | Taxa: ${(stats.stats.responseRate * 100).toFixed(1)}%`);
                }
            } catch (error) {
                console.log(`[${new Date().toLocaleTimeString()}] Erro: ${error.message}`);
            }
        }, 5000); // A cada 5 segundos

        // Parar monitor com CTRL+C
        process.once('SIGINT', () => {
            clearInterval(interval);
            console.log('\nüëÅÔ∏è Monitor parado.');
        });
    }

    /**
     * ‚ö° OTIMIZAR PERFORMANCE
     */
    async handleOptimizeCommand() {
        console.log('\n‚ö° OTIMIZANDO PERFORMANCE...');

        try {
            // Aqui voc√™ implementaria a l√≥gica de otimiza√ß√£o
            console.log('üîç Analisando padr√µes...');
            console.log('üìà Calculando melhorias...');
            console.log('‚úÖ Otimiza√ß√£o conclu√≠da!');
            console.log('üí° Sugest√µes aplicadas automaticamente.');

        } catch (error) {
            console.log(`‚ùå Erro na otimiza√ß√£o: ${error.message}`);
        }
    }

    /**
     * ‚ùì MOSTRAR AJUDA
     */
    showHelp() {
        console.log('\n‚ùì AJUDA - COMANDOS DETALHADOS:');
        console.log('='.repeat(60));
        console.log('status           - Mostra status completo do agente');
        console.log('config           - Interface para alterar configura√ß√µes');
        console.log('test <mensagem>  - Testa como o agente responderia');
        console.log('stats [empresa]  - Estat√≠sticas (todas ou empresa espec√≠fica)');
        console.log('companies        - Lista todas as empresas cadastradas');
        console.log('monitor          - Acompanha m√©tricas em tempo real');
        console.log('optimize         - Executa otimiza√ß√µes autom√°ticas');
        console.log('quit             - Sair da interface');
        console.log('\nüí° DICAS:');
        console.log('- Use n√∫meros (1-9) ou nomes completos dos comandos');
        console.log('- Para teste: "test Ol√°, preciso de ajuda"');
        console.log('- Para stats de empresa: "stats empresa-123"');
    }

    /**
     * üö™ SAIR
     */
    async quit() {
        console.log('\nüö™ Encerrando Agent Control Interface...');
        this.isRunning = false;
        this.rl.close();
        process.exit(0);
    }

    /**
     * ‚ùì FAZER PERGUNTA
     */
    askQuestion(question) {
        return new Promise((resolve) => {
            this.rl.question(question, (answer) => {
                resolve(answer);
            });
        });
    }

    /**
     * üìä EMOJI DE STATUS
     */
    getStatusEmoji(status) {
        switch (status) {
            case 'healthy': return '‚úÖ';
            case 'degraded': return '‚ö†Ô∏è';
            case 'error': return '‚ùå';
            default: return '‚ùì';
        }
    }
}

// Executar se chamado diretamente
if (require.main === module) {
    const interface = new AgentControlInterface();
    interface.start().catch(console.error);
}

module.exports = AgentControlInterface;
